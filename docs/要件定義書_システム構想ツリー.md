# 要件定義書: システム構想ツリー機能

## 1. 概要

G-progressは株式会社Gハウスの建設プロジェクト管理システムとして開始し、将来的に**会社全体の基幹システム**として6つの事業を包括する総合経営管理システムへと発展する構想です。

この要件定義書では、設定画面に実装された「今後の構想」ツリー図機能について説明します。

## 2. 目的

- 経営陣や従業員に対して、G-progressの全体像と将来展望を視覚的に提示する
- 他社へのプレゼンテーション時に、システムの包括性と拡張性を効果的にアピールする
- 現在実装済みの機能と今後計画中の機能を明確に区別して表示する
- 会社全体のDX推進における中核システムとしての位置付けを明示する

## 3. 機能要件

### 3.1 アクセス方法

- **場所**: 設定画面（`/settings`）
- **トリガー**: 「今後の構想を見る」ボタンをクリック
- **表示形式**: モーダルウィンドウ

### 3.2 ツリー構造の設計

#### レベル1: ルートノード
- **名称**: G-progress
- **サブタイトル**: 総合経営管理システム
- **デザイン**: グラデーション背景（青→紫）、白文字、太いボーダー

#### レベル2: 6つの事業部門（横並び展開）

1. **注文住宅事業** （実装中）
   - ステータス: 緑色バッジ「実装中」（アニメーション付き）
   - さらに詳細展開あり（レベル3）

2. **不動産事業** （予定）
   - ステータス: グレーバッジ「予定」
   - 透明度70%

3. **外構事業** （予定）
   - ステータス: グレーバッジ「予定」
   - 透明度70%

4. **賃貸管理事業** （予定）
   - ステータス: グレーバッジ「予定」
   - 透明度70%

5. **リフォーム事業** （予定）
   - ステータス: グレーバッジ「予定」
   - 透明度70%

6. **BtoB事業** （予定）
   - ステータス: グレーバッジ「予定」
   - 透明度70%

#### レベル3: 注文住宅事業の詳細展開（右方向に展開）

##### 実装済み機能
- 案件管理
- タスク管理
- 入金管理
- 粗利益管理
- 性能管理

##### 計画中機能
- ミスロス報告
- 発注・積算
- オプション管理
- キャンペーン情報

#### レベル2.5: 全社共通（6事業と同じ階層）

7. **全社共通** （実装中）
   - ステータス: 緑色バッジ「実装中」（アニメーション付き）
   - さらに詳細展開あり（レベル3）

##### 実装済み機能
- 従業員管理
- 承認フロー

### 3.3 ビジュアルデザイン要件

#### デザインスタイル
- **Prismaテーマ**: 全体のデザインはPrisma design systemに準拠
- **レイアウト**: 横型ツリー構造（左から右へ展開）
- **接続線**: グレー（ダークモード対応）
- **カラーコーディング**:
  - 実装中: 緑色（`border-green-500`, `bg-green-50`, `text-green-800`）
  - 予定: グレー（`border-gray-400`, `bg-gray-50`, `text-gray-700`）

#### レスポンシブ対応
- モーダル最大幅: 1400px
- モーダル最大高さ: 90vh
- 横スクロール対応（`overflow-x-auto`）
- ダークモード対応

### 3.4 インタラクション要件

- モーダル外クリックで閉じる
- 「閉じる」ボタン（右上のXアイコン、フッターの閉じるボタン）
- アニメーション: 実装中バッジにパルスアニメーション（`animate-pulse`）

## 4. 非機能要件

### 4.1 パフォーマンス
- モーダルの開閉は即座に反応
- ツリー図の描画は遅延なく完了

### 4.2 アクセシビリティ
- 大きな文字サイズ（最小でもtext-base）
- 高コントラスト（Prismaテーマの太いボーダー）
- ダークモード対応で目の疲労軽減

### 4.3 保守性
- コンポーネント: `src/pages/Settings.tsx`
- 将来的に事業が増えた場合、容易に追加可能な構造
- 実装状況の変更が簡単（バッジの色とステータスを変更するだけ）

## 5. システムアーキテクチャ

### 5.1 技術スタック
- **フロントエンド**: React + TypeScript
- **スタイリング**: Tailwind CSS + Prisma custom classes
- **アイコン**: Lucide React（Sparkles, X）
- **状態管理**: React useState

### 5.2 実装ファイル
- `src/pages/Settings.tsx` (行179-385)
  - モーダル表示状態: `const [showRoadmap, setShowRoadmap] = useState(false)`
  - ボタン: 「今後の構想を見る」（Sparklesアイコン付き）
  - モーダル本体: 横型ツリー構造のJSX

## 6. 将来展望

### 6.1 フェーズ計画

**第1フェーズ（現在）**: 注文住宅事業の基盤機能構築
- 案件管理、タスク管理、入金管理、性能管理

**第2フェーズ（短期）**: 注文住宅事業の拡張機能
- 承認フロー、ミスロス報告、発注・積算、オプション管理、キャンペーン情報

**第3フェーズ（中期）**: 他事業部門への展開
- 不動産事業、外構事業、賃貸管理事業、リフォーム事業、BtoB事業

### 6.2 システム統合ビジョン

G-progressは最終的に以下を実現する総合経営管理システムとなります：

1. **データ統合**: 全事業部門のデータを一元管理
2. **業務効率化**: 部門間の情報共有と連携を促進
3. **経営判断支援**: リアルタイムなダッシュボードと分析機能
4. **顧客体験向上**: 全サービスラインでの一貫した顧客管理
5. **スケーラビリティ**: 新規事業追加時の柔軟な拡張性

## 7. プレゼンテーション活用

### 7.1 対象者
- 社内経営陣（システム投資の妥当性説明）
- 社内従業員（システムの全体像理解、モチベーション向上）
- 他社（同業他社や関連企業へのシステム提案）
- 投資家・パートナー（事業拡大計画の説明）

### 7.2 効果的な見せ方
1. デモモードで設定画面を開く
2. 「今後の構想を見る」ボタンをクリック
3. 横型ツリー構造で全体像を提示
4. 実装済み機能を強調（緑色バッジ、パルスアニメーション）
5. 計画中機能を説明（グレーバッジ、将来性をアピール）
6. フェーズ情報カードで段階的な展開計画を説明

## 8. メンテナンス手順

### 8.1 ステータス更新方法

機能の実装が完了した際の更新手順：

1. `src/pages/Settings.tsx` を開く
2. 該当機能のバッジを変更:
   ```tsx
   // 変更前（計画中）
   <span className="prisma-badge prisma-badge-gray">予定</span>

   // 変更後（実装中）
   <span className="prisma-badge prisma-badge-green animate-pulse">実装中</span>
   ```

3. カードのスタイルを変更:
   ```tsx
   // 変更前
   className="prisma-card opacity-70"

   // 変更後
   className="prisma-card border-3 border-green-500 shadow-xl"
   ```

### 8.2 新規事業追加方法

1. 6事業の下に新しい事業divを追加
2. 縦幹線（`absolute left-0 top-0 bottom-0`）の範囲を調整
3. 横接続線と事業カードを同様のパターンで実装
4. フェーズ情報を更新

## 9. デザインガイドライン

### 9.1 基本原則

**最重要**: すべてのコンポーネントで**Prismaデザインコードを常に意識**すること

- 大きく明確な文字サイズ（最小text-base、タイトルはtext-xl以上）
- 太いボーダー（border-3またはborder-4）を使用
- はっきりとした色使い（グラデーションよりもソリッドカラーを優先）
- 十分な余白とパディング
- クリック可能な要素は明確にホバーエフェクトを表示
- ユニバーサルデザイン（高齢者でも見やすい）

### 9.2 Prismaテーマ準拠

- `prisma-card`: カード基本スタイル
- `prisma-badge-green`: 実装中バッジ
- `prisma-badge-gray`: 予定バッジ
- `prisma-btn-primary`: メインボタン
- `prisma-modal-overlay`: モーダル背景
- `prisma-modal`: モーダル本体
- `prisma-modal-header`: モーダルヘッダー
- `prisma-modal-content`: モーダルコンテンツ
- `prisma-modal-footer`: モーダルフッター

### 9.2 カラーパレット

| 要素 | ライトモード | ダークモード |
|------|------------|-------------|
| ルートノード背景 | グラデーション（青→紫） | グラデーション（青→紫） |
| 実装中カード | `bg-green-50`, `border-green-500` | `bg-green-900/20`, `border-green-500` |
| 予定カード | `bg-white`, `border-gray-300` | `bg-gray-800`, `border-gray-600` |
| 接続線 | `bg-gray-600` | `bg-gray-400` |
| フェーズ情報背景 | `from-blue-50 to-purple-50` | `from-gray-800 to-gray-700` |

## 10. データベース要件（2025-10-23追加）

### 10.1 コアテーブル構造

#### tasksテーブル
- **task_master_id**: UUID型、task_mastersテーブルへの外部キー
- **目的**: タスクマスタとの紐付けを実現
- **外部キー制約名**: `tasks_task_master_id_fkey`
- **マイグレーション**: `205_add_task_master_id_to_tasks.sql`

#### system_settingsテーブル（2025-10-23追加）
- **目的**: システム設定（kintone連携など）の保存
- **主要カラム**:
  - `id`: UUID PRIMARY KEY
  - `key`: TEXT UNIQUE NOT NULL（設定のキー）
  - `value`: JSONB（設定の値）
  - `created_at`, `updated_at`: TIMESTAMPTZ
- **マイグレーション**: `206_create_system_tables.sql`

#### backup_logsテーブル（2025-10-23追加）
- **目的**: バックアップ履歴の記録
- **主要カラム**:
  - `id`: UUID PRIMARY KEY
  - `status`: TEXT NOT NULL（success/partial/error）
  - `total_records`, `success_count`, `error_count`: INTEGER
  - `duration_seconds`: INTEGER
  - `error_message`: TEXT
  - `created_at`: TIMESTAMPTZ
- **マイグレーション**: `206_create_system_tables.sql`

### 10.2 RLS（Row Level Security）ポリシー

すべてのテーブルでRLSが有効化されており、認証されたユーザーのみがアクセス可能：

```sql
-- 読み取りポリシー
CREATE POLICY "Allow all authenticated users to read [table_name]"
  ON [table_name] FOR SELECT
  TO authenticated
  USING (true);

-- 書き込みポリシー
CREATE POLICY "Allow all authenticated users to update [table_name]"
  ON [table_name] FOR ALL
  TO authenticated
  USING (true);
```

### 10.3 PostgreSQL構文の注意事項

**重要**: PostgreSQLでは以下の構文は**サポートされていない**

❌ `CREATE POLICY IF NOT EXISTS`
❌ `CREATE TRIGGER IF NOT EXISTS`

✅ 正しい方法:
```sql
DROP POLICY IF EXISTS "policy_name" ON table_name;
CREATE POLICY "policy_name" ON table_name ...

DROP TRIGGER IF EXISTS trigger_name ON table_name;
CREATE TRIGGER trigger_name ...
```

## 11. 設定画面の統合機能（2025-10-23追加）

### 11.1 概要

従来の「設定」と「システム設定」を1つのページに統合し、タブ切り替えで機能を分離。

### 11.2 タブ構成

#### タブ1: 基本設定
- **デモモード**: サンプルデータの表示切り替え
- **ダークモード**: テーマの切り替え
- **設定状態表示**: 現在の設定の確認

#### タブ2: kintone連携
- **kintone設定**: ドメイン、APIトークン、アプリID
- **接続テスト**: kintone接続の確認
- **手動バックアップ**: プロジェクトデータのバックアップ実行
- **バックアップ履歴**: 過去のバックアップログ表示

#### タブ3: システム構想
- **システム構想ツリー**: 全社システムの全体像表示

### 11.3 技術仕様

- **ファイル**: `src/pages/Settings.tsx`
- **統合元**: `src/pages/SystemSettings.tsx`（archive化）
- **状態管理**: useState（タブ切り替え用）
- **データ保存**:
  - LocalStorage（デモモード、ダークモード）
  - Supabase（kintone設定、バックアップログ）

## 12. 粗利益管理画面の改善（2025-10-23追加）

### 12.1 テーブル列配置の改善

**問題**: ヘッダーとデータの列がずれていた

**解決策**:
- `table-layout: fixed`で列幅を固定
- `<colgroup>`で各列に明確な幅を設定
- 列幅配分: 20%, 15%, 18%, 18%, 18%, 11%

### 12.2 サマリーカードのレイアウト改善

**変更内容**:
- アイコン、ラベル、数値を縦に配置
- 中央揃えで視認性向上
- ラベルの直下に数値を表示

**レイアウト構造**:
```
┌─────────────┐
│   アイコン   │
│   ラベル     │
│   数値       │
└─────────────┘
```

## 13. 承認・変更履歴

| 日付 | バージョン | 変更内容 | 承認者 |
|------|----------|---------|-------|
| 2025-10-21 | 1.0 | 初版作成 | - |
| 2025-10-23 | 1.1 | データベース要件、設定画面統合、粗利益管理改善を追加 | - |

---

**文書管理**
- ファイル名: `要件定義書_システム構想ツリー.md`
- 保存場所: `C:\claudecode\G-progress\docs\`
- 関連ファイル:
  - `src/pages/Settings.tsx`
  - `src/pages/GrossProfitManagement.tsx`
  - `supabase/migrations/205_add_task_master_id_to_tasks.sql`
  - `supabase/migrations/206_create_system_tables.sql`

---

## 11. 全社リリース要件（2025年10月23日更新）

### 11.1 リリース準備の全体進捗

**総進捗率**: 17% (121.5日中21日相当完了)  
**最終更新**: 2025年10月23日

### 11.2 クリティカル（リリースブロッカー）

#### 🔴 認証機能未実装
- **現状**: 開発用バイパス（Login.tsx）
- **影響**: セキュリティリスク大、本番運用不可
- **対策**: Supabase Auth実装が最優先
- **所要時間**: 3〜4日
- **担当**: フロントエンド開発チーム

#### 🔴 本番環境未構築
- **現状**: 開発環境のみ
- **影響**: リリース不可
- **対策**: Vercel + Supabase本番環境セットアップ
- **所要時間**: 1日
- **担当**: インフラ担当

#### 🔴 テスト未実施
- **現状**: 単体テスト3ファイルのみ
- **影響**: バグ多発リスク
- **対策**: 最低限UAT（ユーザー受け入れテスト）実施
- **所要時間**: 5日
- **担当**: QA担当 + 業務担当者

### 11.3 高優先度項目

#### 🟡 console.log削除
- **現状**: 約150箇所以上のデバッグログ
- **影響**: パフォーマンス低下、情報漏洩リスク
- **対策**: 本番ビルド前に全削除
- **所要時間**: 0.5日

#### 🟡 大規模ファイルのリファクタリング
- **現状**: ProjectList.tsx (87KB), DashboardHome.tsx (60KB)
- **影響**: 保守性低下
- **対策**: コンポーネント分割
- **所要時間**: 2日

#### 🟡 セキュリティ対策
- **必須項目**:
  - HTTPS設定
  - セキュリティヘッダー設定
  - セキュリティ診断実施
- **所要時間**: 2.5日

### 11.4 リリースまでの推奨スケジュール

**最短スケジュール（5週間）**:
1. **Week 1**: 認証機能実装 (4日)
2. **Week 2**: 本番環境構築 + データ整備 (3日)
3. **Week 3**: テスト実施 (5日)
4. **Week 4**: セキュリティ対策 + ドキュメント (9日)
5. **Week 5**: トレーニング + 最終調整 (10日)

**推奨スケジュール（8週間）**:
- 余裕を持った開発・テスト期間
- ユーザートレーニングの充実
- 段階的ロールアウト可能

### 11.5 完了した主要項目（2025年10月23日時点）

#### ✅ UI/UX
- Prismaデザイン原則完全準拠
- **全モーダルPrisma仕様適合（2025-10-24追加）**:
  - 16ファイル、20+モーダルを包括的にチェック
  - 6モーダルをPrisma仕様に修正（ProjectList.tsx 4件、DashboardHome.tsx 2件）
  - 適切なクラス使用: `prisma-modal-overlay`, `prisma-modal`, `prisma-input`, `prisma-select`
  - 最小フォントサイズ: text-base (16px)
  - ボーダー: border-3/4
  - デザイン統一により社内・FC利用者の作業効率向上
- レスポンシブデザイン（スマホ・タブレット対応）
- モバイルUI最適化

#### ✅ 機能実装
- kintoneバックアップ機能
- タスクマスタ管理
- 粗利益管理（3段階表示）
- 案件詳細（タブ統合、担当者フィルタリング）
- 職種別ビュー（テーブル化）
- 履歴ログ（監査ログ）

#### ✅ データベース
- 206個のマイグレーション完了
- RLSポリシー強化
- インデックス最適化
- 外部キー制約追加

#### ✅ コード品質
- TypeScript型エラー0件
- **デプロイエラー修正（2025-10-24追加）**: Dashboard.tsxのSamplePage import削除
- 用語統一（営業担当→営業、設計担当→意匠設計、等）
- 不要ファイル削除（SamplePage.tsx、35個のデバッグスクリプト）
- **「今日へジャンプ」ボタン修正（2025-10-24追加）**: todayRowRefの正しい受け渡し実装
- **グリッドビュー表示日数拡張（2025-10-24追加）**: 常に999日まで表示（長期プロジェクト対応）

### 11.6 残作業の見積もり

| カテゴリ | 残作業日数 | 優先度 |
|---------|----------|--------|
| 認証・セキュリティ | 6.5日 | 🔴 最高 |
| テスト | 5日 | 🔴 最高 |
| 本番環境構築 | 1日 | 🔴 最高 |
| ドキュメント | 9日 | 🟡 高 |
| トレーニング | 12日 | 🟡 高 |
| パフォーマンス最適化 | 2.5日 | 🟢 中 |
| **合計（優先度高のみ）** | **36日** | - |

### 11.7 リスク管理

#### 技術リスク
- 認証実装の複雑性 → Supabase Auth使用で軽減
- 本番環境のパフォーマンス → 負荷テスト必須
- データ移行の失敗 → CSVインポート機能で対応済み

#### 運用リスク
- ユーザートレーニング不足 → マニュアル整備とハンズオン研修
- データバックアップ失敗 → kintone連携で二重化
- 本番障害発生 → 段階的ロールアウトで影響最小化

### 11.8 成功基準

#### リリース可否判断基準
- ✅ 認証機能が正常に動作すること
- ✅ 本番環境が安定稼働すること
- ✅ UAT合格（主要ユースケース100%動作）
- ✅ セキュリティ診断で重大な脆弱性が無いこと
- ✅ ユーザーマニュアルが完成していること

#### リリース後KPI
- システム稼働率: 99.9%以上
- ページ読み込み時間: 3秒以内
- ユーザー満足度: 80%以上
- 重大バグ: 月1件以下

---

**最終更新日**: 2025年10月24日
**次回レビュー日**: 2025年10月30日
