# タスク日付確定機能 実装ガイド

## 概要

案件詳細画面において、以下の3つの機能を実装しました：

1. **遅延タスクの自動判定**: 今日よりも前の期限で未完了のタスクを「遅れ」として視覚的に強調表示
2. **確定日付の「確」マーク表示**: 日付が確定しているタスクにタスク名の右上に緑色の丸で「確」マークを表示
3. **予定/確定の切り替え**: タスク詳細モーダルで日付ステータスを予定⇔確定で切り替え可能

---

## 実装内容

### 1. データベース変更

#### tasksテーブルに新しいカラム追加

```sql
ALTER TABLE tasks
ADD COLUMN IF NOT EXISTS is_date_confirmed BOOLEAN DEFAULT FALSE;
```

- **カラム名**: `is_date_confirmed`
- **型**: BOOLEAN
- **デフォルト値**: FALSE（予定）
- **意味**:
  - `FALSE` = 予定
  - `TRUE` = 確定

#### マイグレーションSQL

ファイル: `supabase/migrations/add_is_date_confirmed_to_tasks.sql`

**実行手順**:
1. [Supabaseダッシュボード](https://app.supabase.com/project/qxftwxkpeqvlukjybnfp)を開く
2. 左サイドバーから「SQL Editor」をクリック
3. 新規クエリを作成
4. 上記SQLファイルの内容をコピー&ペースト
5. 「Run」ボタンをクリック
6. 成功メッセージを確認

---

### 2. フロントエンド実装

#### A. Taskインターフェースの更新

**ファイル**: `src/types/database.ts`

```typescript
export interface Task {
  // ...既存のフィールド
  is_date_confirmed?: boolean // 日付確定フラグ（false: 予定、true: 確定）
  // ...
}
```

#### B. タスクカードに「確」マークを表示

**ファイル**: `src/components/ProjectDetailFields.tsx`

**実装箇所**:
- **グリッドビュー**: 312-333行（タスクカードの右上に緑の丸バッジ）
- **職種別ビュー**: 443-452行（タスク名の横に緑の丸バッジ）

**表示例**:
```
┌─────────────┐
│ タスク名  ⓪│  ← 「確」マークが右上に表示
└─────────────┘
```

#### C. タスク詳細モーダルに予定/確定切り替え

**ファイル**: `src/pages/ProjectDetail.tsx`

**実装箇所**: 1152-1213行

**機能**:
- 現在のステータス表示（予定 or 確定）
- 「確」マークの表示（確定時のみ）
- ボタンクリックで予定⇔確定を切り替え
- 編集ロック対応
- トースト通知でユーザーにフィードバック

**UI構成**:
```
┌────────────────────────────────────────────────┐
│ 日付ステータス                                 │
├────────────────────────────────────────────────┤
│ [確定] ⓪  [予定に戻す]  この日付は確定してい  │
│                        ます。変更が必要な場合  │
│                        は予定に戻してください。│
└────────────────────────────────────────────────┘
```

#### D. 遅延タスクの自動判定

**ファイル**: `src/components/ProjectDetailFields.tsx`

**実装箇所**: 305-309行、412-414行

**判定ロジック**:
```typescript
const isDelayed = task.status === 'delayed' || (
  task.due_date &&
  task.status !== 'completed' &&
  new Date(task.due_date) < new Date()
)
```

**表示**:
- 遅延タスクは赤背景＋赤ボーダーで強調（`task-delayed`クラス）
- ステータスが「遅延」と表示

---

## 使用方法

### 1. タスクの日付を確定する

1. 案件詳細画面を開く
2. 確定したいタスクをクリック
3. タスク詳細モーダルが開く
4. 「日付ステータス」セクションを確認
5. 「日付を確定する」ボタンをクリック
6. タスクに「確」マークが表示される

### 2. 確定日付を予定に戻す

1. タスク詳細モーダルを開く
2. 「予定に戻す」ボタンをクリック
3. 「確」マークが消える

### 3. 遅延タスクを確認する

- グリッドビューまたは職種別ビューで、赤背景のタスクが遅延タスク
- 自動的に判定される（今日より前の期限で未完了のタスク）

---

## 視覚的な違い

### タスクカード

| ステータス | 背景色 | ボーダー | マーク |
|-----------|--------|---------|--------|
| 未着手（予定） | 赤系 | 赤 | なし |
| 未着手（確定） | 赤系 | 赤 | **確** ⓪ |
| 着手中（予定） | 黄色系 | 黄色 | なし |
| 着手中（確定） | 黄色系 | 黄色 | **確** ⓪ |
| 完了 | 青系 | 青 | なし |
| **遅延** | **赤背景** | **太い赤枠** | なし |

### 日付ステータスセクション

**予定の場合**:
```
┌────────────────────────────────────────────────┐
│ 日付ステータス                                 │
├────────────────────────────────────────────────┤
│ [予定]  [日付を確定する]  この日付は予定です。│
│                          確定する場合はボタン  │
│                          を押してください。    │
└────────────────────────────────────────────────┘
```

**確定の場合**:
```
┌────────────────────────────────────────────────┐
│ 日付ステータス                                 │
├────────────────────────────────────────────────┤
│ [確定] ⓪  [予定に戻す]  この日付は確定してい  │
│                        ます。変更が必要な場合  │
│                        は予定に戻してください。│
└────────────────────────────────────────────────┘
```

---

## デプロイ手順

### 1. データベースマイグレーション

```bash
# Supabaseダッシュボードで以下のSQLを実行
# ファイル: supabase/migrations/add_is_date_confirmed_to_tasks.sql

ALTER TABLE tasks
ADD COLUMN IF NOT EXISTS is_date_confirmed BOOLEAN DEFAULT FALSE;

UPDATE tasks
SET is_date_confirmed = FALSE
WHERE is_date_confirmed IS NULL;

COMMENT ON COLUMN tasks.is_date_confirmed IS '日付確定フラグ（FALSE: 予定、TRUE: 確定）';
```

### 2. フロントエンドのデプロイ

```bash
# ビルド
npm run build

# Vercelにデプロイ
vercel --prod
```

### 3. 動作確認

1. 案件詳細画面を開く
2. タスクをクリックして詳細モーダルを表示
3. 「日付を確定する」ボタンが表示されることを確認
4. ボタンをクリックして「確」マークが表示されることを確認
5. グリッドビューと職種別ビューで「確」マークが表示されることを確認
6. 過去の日付で未完了のタスクが赤く表示されることを確認

---

## トラブルシューティング

### 「確」マークが表示されない

**原因**: データベースマイグレーションが未実行

**解決方法**:
1. Supabaseダッシュボードでマイグレーションを実行
2. ページをリロード

### 日付ステータスの切り替えが失敗する

**原因**: 他のユーザーが編集中（編集ロック）

**解決方法**:
1. タスク詳細モーダルを一度閉じる
2. 再度開く
3. 編集ロックが解放されるまで待つ

### 遅延タスクが赤く表示されない

**原因**: タスクのステータスが「完了」になっている

**解決方法**:
- 遅延判定は「完了」以外のタスクのみに適用されます
- タスクのステータスを確認してください

---

## 技術的な詳細

### 遅延判定の優先順位

1. `task.status === 'delayed'` の場合は強制的に遅延扱い
2. 期限日が今日より前 AND ステータスが未完了の場合は遅延扱い
3. 上記以外は通常のステータス色を適用

### 編集ロックとの連携

- 日付ステータスの変更時も編集ロックを尊重
- 他のユーザーが編集中の場合はボタンが無効化
- ロックエラー時はトースト通知で警告

### パフォーマンス

- `is_date_confirmed`フィールドはBOOLEAN型でインデックス不要
- タスク表示時にクライアント側で判定（サーバー負荷なし）
- リアルタイム更新対応

---

## 今後の拡張案

1. **一括確定機能**: 複数のタスクを一度に確定できる機能
2. **確定通知**: 日付が確定された時にSlackやLINEで通知
3. **確定履歴**: いつ誰が確定したかの履歴記録
4. **確定権限**: 特定の役職のみが確定できるように権限管理

---

**最終更新日**: 2025-10-26
**バージョン**: 1.0
**実装者**: Claude Code
