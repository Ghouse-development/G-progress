# 予定からのずれ機能 実装ガイド

## 概要

タスクの期限日が当初の予定から変更された場合に、その変更を視覚的に表示する機能を実装しました。

**目的**:
- タスクの日付が予定通りなのか、ずれているのかを一目で把握
- 当初からどれだけ日数がずれたかを明確に表示
- 日付変更の履歴（変更回数）を記録

---

## 実装内容

### 1. データベース変更

#### tasksテーブルに新しいカラム追加

```sql
ALTER TABLE tasks
ADD COLUMN IF NOT EXISTS original_due_date DATE;

ALTER TABLE tasks
ADD COLUMN IF NOT EXISTS date_change_count INTEGER DEFAULT 0;

ALTER TABLE tasks
ADD COLUMN IF NOT EXISTS last_date_changed_at TIMESTAMP;
```

- **original_due_date**: 当初の予定日（最初に設定された期限日）
- **date_change_count**: 期限日の変更回数
- **last_date_changed_at**: 最終日付変更日時

#### マイグレーションSQL

ファイル: `supabase/migrations/add_original_due_date_to_tasks.sql`

**実行手順**:
1. [Supabaseダッシュボード](https://app.supabase.com/project/qxftwxkpeqvlukjybnfp)を開く
2. 左サイドバーから「SQL Editor」をクリック
3. 新規クエリを作成
4. SQLファイルの内容をコピー&ペースト
5. 「Run」ボタンをクリック
6. 成功メッセージを確認

**重要**: 既存のタスクについては、`original_due_date`が未設定の場合、現在の`due_date`で自動的に初期化されます。

---

### 2. フロントエンド実装

#### A. Taskインターフェースの更新

**ファイル**: `src/types/database.ts`

```typescript
export interface Task {
  // ...既存のフィールド
  is_date_confirmed?: boolean // 日付確定フラグ
  original_due_date?: string // 当初の予定日
  date_change_count?: number // 期限日の変更回数
  last_date_changed_at?: string // 最終日付変更日時
  // ...
}
```

#### B. タスク詳細モーダルに変更履歴表示

**ファイル**: `src/pages/ProjectDetail.tsx`

**実装箇所**: 1215-1250行（日付ステータスセクションの後）

**表示内容**:
- 当初予定日と現在の期限日の比較
- 日数のずれ（後ろ倒し/前倒し）
- 変更回数の表示
- 黄色の警告ボックスで目立たせる

**UI例**:
```
┌───────────────────────────────────────────┐
│ ⚠️ 5日後ろ倒し                            │
│ 当初予定: 2025年10月25日 (金)            │
│ → 現在: 2025年10月30日 (水)              │
│ 変更回数: 2回                             │
└───────────────────────────────────────────┘
```

#### C. グリッドビュー・職種別ビューに変更アイコン表示

**ファイル**: `src/components/ProjectDetailFields.tsx`

**実装箇所**:
- **グリッドビュー**: 352-356行（タスクカードの右下）
- **職種別ビュー**: 463-467行（タスク名の右下）

**表示**:
- 黄色の円形バッジに警告アイコン（⚠️）
- ホバー時にツールチップで詳細表示
- 「確」マークの下に配置

---

## 視覚的な表示

### タスクカードでの表示

```
┌──────────────────┐
│ タスク名  ⓪     │  ← 「確」マーク（右上）
│              ⚠️  │  ← 変更アイコン（右下）
└──────────────────┘
```

### バッジの意味

| バッジ | 意味 | 色 |
|--------|------|-----|
| **⓪** | 日付確定 | 緑 |
| **⚠️** | 予定からずれあり | 黄色 |

### ツールチップ表示例

マウスホバー時に表示される詳細情報：
- 「当初予定から5日後ろ倒し」
- 「当初予定から3日前倒し」

---

## 使用方法

### 1. タスク作成時の自動設定

- タスク作成時、`due_date`を設定すると自動的に`original_due_date`にも同じ日付が保存される
- この時点では変更なしとして扱われる

### 2. 期限日変更時の処理

**現在の実装**:
- タスク詳細モーダルで期限日を変更すると、新しい期限日が保存される
- `original_due_date`は変更されない

**今後の拡張**（実装予定）:
- 期限日変更時に`date_change_count`を自動インクリメント
- `last_date_changed_at`を自動更新
- 変更履歴のログを記録

### 3. 変更の確認

#### タスク詳細モーダルで確認
1. 案件詳細画面を開く
2. タスクをクリック
3. 「予定からのずれ」セクションを確認
4. 当初予定と現在の期限日の差を確認

#### グリッドビュー・職種別ビューで確認
1. タスクカードに黄色の⚠️アイコンが表示されているか確認
2. アイコンにマウスホバーで詳細を表示

---

## デプロイ手順

### 1. データベースマイグレーション

```bash
# Supabaseダッシュボードで以下のSQLを実行
# ファイル: supabase/migrations/add_original_due_date_to_tasks.sql
```

### 2. フロントエンドのデプロイ

```bash
# ビルド
npm run build

# Vercelにデプロイ
vercel --prod
```

### 3. 動作確認

1. 案件詳細画面を開く
2. タスクの期限日を変更
3. タスク詳細モーダルを開く
4. 「予定からのずれ」セクションが表示されることを確認
5. グリッドビュー・職種別ビューで⚠️アイコンが表示されることを確認

---

## トラブルシューティング

### 変更アイコンが表示されない

**原因1**: データベースマイグレーションが未実行

**解決方法**:
1. Supabaseダッシュボードでマイグレーションを実行
2. ページをリロード

**原因2**: 既存タスクで`original_due_date`が未設定

**解決方法**:
```sql
-- 既存タスクの初期化
UPDATE tasks
SET original_due_date = due_date::date
WHERE original_due_date IS NULL AND due_date IS NOT NULL;
```

### 変更履歴が表示されない

**原因**: `original_due_date`と`due_date`が同じ

**確認方法**:
- タスク詳細モーダルで期限日を変更してみる
- 変更後、⚠️アイコンが表示されるはず

---

## 今後の拡張案

### 1. 自動変更カウント

期限日変更時に自動的に以下を更新：
```typescript
const { error } = await supabase
  .from('tasks')
  .update({
    due_date: newDueDate,
    date_change_count: (task.date_change_count || 0) + 1,
    last_date_changed_at: new Date().toISOString()
  })
  .eq('id', task.id)
```

### 2. 変更履歴テーブル

タスクの期限日変更履歴を別テーブルで管理：
```sql
CREATE TABLE task_date_history (
  id UUID PRIMARY KEY,
  task_id UUID REFERENCES tasks(id),
  old_due_date DATE,
  new_due_date DATE,
  changed_by UUID REFERENCES employees(id),
  changed_at TIMESTAMP,
  reason TEXT
);
```

### 3. ダッシュボードでの統計

- 期限日変更が多いタスク種別を分析
- 平均的な後ろ倒し日数を表示
- 予定通り完了したタスクの割合を表示

### 4. 通知機能

- 期限日が大幅に変更された場合に通知
- 連続して変更された場合にアラート

---

## 技術的な詳細

### 日付比較ロジック

```typescript
// 日付が変更されているかチェック
const hasDateChanged = task.original_due_date &&
  task.due_date &&
  task.original_due_date !== task.due_date

// 日数の差分を計算
const daysDiff = differenceInDays(
  new Date(task.due_date),
  new Date(task.original_due_date)
)

// 後ろ倒し / 前倒しの判定
const direction = daysDiff > 0 ? '後ろ倒し' : '前倒し'
const absDays = Math.abs(daysDiff)
```

### パフォーマンス

- `original_due_date`フィールドはDATE型で軽量
- クライアント側で差分計算（サーバー負荷なし）
- インデックス不要（検索条件として使用しない）

---

**最終更新日**: 2025-10-26
**バージョン**: 1.0
**実装者**: Claude Code
