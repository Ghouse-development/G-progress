# 遅延タスク機能 実装ガイド

## 概要

期限日を過ぎた未完了タスクを自動的に検知し、専用ページで一覧表示する機能を実装しました。

**実装内容**:
1. タスクにコメント欄を追加
2. 遅延タスク専用ページの作成
3. 自動遅延検知ロジック（フロントエンド）

---

## 実装内容

### 1. データベース変更

#### tasksテーブルにcommentカラム追加

```sql
ALTER TABLE tasks
ADD COLUMN IF NOT EXISTS comment TEXT;

COMMENT ON COLUMN tasks.comment IS 'タスクに対するコメント（遅延理由、進捗状況など）';
```

**マイグレーションファイル**: `supabase/migrations/add_comment_to_tasks.sql`

**実行手順**:
1. [Supabaseダッシュボード](https://app.supabase.com/project/qxftwxkpeqvlukjybnfp)を開く
2. 左サイドバーから「SQL Editor」をクリック
3. 上記SQLを実行

---

### 2. フロントエンド実装

#### A. Task型にcommentフィールド追加

**ファイル**: `src/types/database.ts`

```typescript
export interface Task {
  // ...既存のフィールド
  comment?: string // タスクに対するコメント（遅延理由、進捗状況など）
}
```

#### B. タスク詳細モーダルにコメント欄追加

**ファイル**: `src/pages/ProjectDetail.tsx` (1297-1328行)

**機能**:
- テキストエリアでコメントを編集
- リアルタイムでデータベースに自動保存
- 編集ロック対応
- プレースホルダーで使い方を案内

**UI**:
```
┌────────────────────────────────────────┐
│ コメント（遅延理由・進捗状況など）    │
├────────────────────────────────────────┤
│ ┌────────────────────────────────────┐ │
│ │ タスクに関するコメントを入力して   │ │
│ │ ください                           │ │
│ └────────────────────────────────────┘ │
└────────────────────────────────────────┘
```

#### C. 遅延タスク専用ページ作成

**ファイル**: `src/pages/DelayedTasks.tsx`

**表示内容**:
| 担当者 | 邸名（案件名） | タスク名 | 予定日 | 遅れ | コメント |
|--------|---------------|---------|--------|------|----------|
| 山田太郎 | ○○邸 | 設計図作成 | 2025/10/20 (金) | 6日遅れ | 顧客からの修正依頼対応中 |

**統計情報**:
- 総遅延タスク数
- 未着手のタスク数
- 着手中のタスク数

**遅延判定ロジック**:
```typescript
// 期限日が今日より前で、未完了のタスク
const today = new Date()
today.setHours(0, 0, 0, 0)

const { data: tasks } = await supabase
  .from('tasks')
  .select(`
    *,
    assigned_employee:employees!tasks_assigned_to_fkey(*),
    project:projects(*)
  `)
  .lt('due_date', today.toISOString())
  .in('status', ['not_started', 'requested', 'delayed'])
  .order('due_date', { ascending: true })
```

#### D. ルーティング設定

**ファイル**: `src/pages/Dashboard.tsx`

```typescript
import DelayedTasks from './DelayedTasks'

// ...

<Route path="/delayed-tasks" element={<DelayedTasks />} />
```

**アクセスURL**: `/delayed-tasks`

---

## 使用方法

### 1. 遅延タスクページへのアクセス

**直接URL**: `https://g-progress.vercel.app/delayed-tasks`

**将来の拡張**:
- サイドバーに「⚠️ 遅延タスク」メニューを追加予定
- ダッシュボードに遅延タスク数を表示予定

### 2. コメントの入力

1. 案件詳細画面でタスクをクリック
2. タスク詳細モーダルを開く
3. 「コメント（遅延理由・進捗状況など）」欄に入力
4. 入力内容は自動保存される

**使用例**:
- 「顧客からの修正依頼対応中」
- 「部材納期遅延により着工延期」
- 「設計変更のため再提出予定」

### 3. 遅延タスクの確認

#### 統計情報
ページ上部に3つの統計カードが表示：
- **総遅延タスク数**: 赤色（すべての遅延タスク）
- **未着手**: 黄色（まだ着手していないタスク）
- **着手中**: オレンジ色（作業中だが遅延しているタスク）

#### 一覧表示
各遅延タスクについて以下を表示：
- **担当者**: アイコン付きで担当者名
- **邸名（案件名）**: どの案件のタスクか
- **タスク名**: タスクの名称
- **予定日**: 当初の期限日
- **遅れ**: 「○日遅れ」と赤字で強調
- **コメント**: 遅延理由や進捗状況

---

## デプロイ手順

### 1. データベースマイグレーション

```bash
# Supabaseダッシュボードで以下のSQLを実行
# ファイル: supabase/migrations/add_comment_to_tasks.sql

ALTER TABLE tasks
ADD COLUMN IF NOT EXISTS comment TEXT;

COMMENT ON COLUMN tasks.comment IS 'タスクに対するコメント（遅延理由、進捗状況など）';
```

### 2. フロントエンドのデプロイ

```bash
# ビルド
npm run build

# Vercelにデプロイ
vercel --prod
```

### 3. 動作確認

1. `/delayed-tasks` にアクセス
2. 遅延タスクが一覧表示されることを確認
3. タスク詳細モーダルでコメントを入力
4. 遅延タスクページでコメントが表示されることを確認

---

## 今後の拡張（自動遅延検知）

### 現在の実装

**フロントエンドでの検知**:
- 遅延タスクページアクセス時にクエリで抽出
- 判定条件: `due_date < today` AND `status IN ('not_started', 'requested', 'delayed')`

### 将来の自動化案

#### 案1: Supabase Edge Functions（推奨）

**メリット**:
- サーバーレスで軽量
- 定期実行可能
- 通知機能と連携しやすい

**実装例**:
```typescript
// supabase/functions/check-delayed-tasks/index.ts
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

serve(async (req) => {
  const supabase = createClient(
    Deno.env.get('SUPABASE_URL') ?? '',
    Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? ''
  )

  const today = new Date()
  today.setHours(0, 0, 0, 0)

  // 遅延タスクを抽出して自動的にステータスを'delayed'に更新
  const { data: tasks, error } = await supabase
    .from('tasks')
    .update({ status: 'delayed' })
    .lt('due_date', today.toISOString())
    .in('status', ['not_started', 'requested'])
    .select('*, assigned_employee:employees(*)')

  // 通知を送信
  if (tasks) {
    for (const task of tasks) {
      await supabase.from('notifications').insert({
        user_id: task.assigned_to,
        type: 'task_delayed',
        title: 'タスクが遅延しています',
        message: `タスク「${task.title}」の期限が過ぎています`,
        related_id: task.id,
        related_type: 'task'
      })
    }
  }

  return new Response(JSON.stringify({ updated: tasks?.length || 0 }), {
    headers: { 'Content-Type': 'application/json' }
  })
})
```

**定期実行設定**:
```bash
# 毎日午前0時に実行
supabase functions schedule check-delayed-tasks --cron "0 0 * * *"
```

#### 案2: PostgreSQL トリガー

**メリット**:
- リアルタイムで即座に反映
- サーバー側で完結

**実装例**:
```sql
CREATE OR REPLACE FUNCTION check_delayed_tasks()
RETURNS trigger AS $$
BEGIN
  -- 期限日が今日より前で未完了のタスクをdelayedに更新
  UPDATE tasks
  SET status = 'delayed'
  WHERE due_date < CURRENT_DATE
  AND status IN ('not_started', 'requested');

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- トリガーを作成（毎日実行）
CREATE TRIGGER trigger_check_delayed_tasks
AFTER INSERT OR UPDATE ON tasks
FOR EACH STATEMENT
EXECUTE FUNCTION check_delayed_tasks();
```

#### 案3: フロントエンドでの定期チェック

**メリット**:
- 実装が簡単
- すぐに始められる

**デメリット**:
- ユーザーがアプリを開いている時のみ動作

**実装例**:
```typescript
// アプリ起動時に1回実行
useEffect(() => {
  const checkDelayedTasks = async () => {
    const today = new Date()
    today.setHours(0, 0, 0, 0)

    await supabase
      .from('tasks')
      .update({ status: 'delayed' })
      .lt('due_date', today.toISOString())
      .in('status', ['not_started', 'requested'])
  }

  checkDelayedTasks()
}, [])
```

### 通知機能の追加

**担当者への通知**:
```typescript
{
  user_id: task.assigned_to,
  type: 'task_delayed',
  title: '⚠️ タスクが遅延しています',
  message: `タスク「${task.title}」の期限（${task.due_date}）が過ぎています`,
  related_id: task.id,
  related_type: 'task',
  priority: 'high'
}
```

**上長への通知**:
```typescript
// 担当者の上長を取得
const { data: supervisor } = await supabase
  .from('employees')
  .select('supervisor_id')
  .eq('id', task.assigned_to)
  .single()

if (supervisor?.supervisor_id) {
  await supabase.from('notifications').insert({
    user_id: supervisor.supervisor_id,
    type: 'subordinate_task_delayed',
    title: '部下のタスクが遅延',
    message: `${employee.name}さんのタスク「${task.title}」が遅延しています`,
    related_id: task.id,
    related_type: 'task',
    priority: 'medium'
  })
}
```

---

## トラブルシューティング

### コメントが保存されない

**原因**: 編集ロックがかかっている

**解決方法**:
1. タスク詳細モーダルを閉じる
2. 他のユーザーの編集が終わるまで待つ
3. 再度タスクを開いて編集

### 遅延タスクページが空

**原因1**: 実際に遅延タスクがない

**確認方法**: 過去の期限日を持つタスクを作成してテスト

**原因2**: データベースクエリエラー

**確認方法**: ブラウザのコンソールでエラーを確認

---

## 技術的な詳細

### 遅延日数の計算

```typescript
const getDelayDays = (dueDate: string) => {
  const today = new Date()
  today.setHours(0, 0, 0, 0)
  return differenceInDays(today, new Date(dueDate))
}
```

### パフォーマンス

- **クエリ最適化**: インデックスを活用（due_date, status）
- **件数制限**: 大量の遅延タスクがある場合はページネーション推奨
- **キャッシュ**: リアルタイムsubscriptionで自動更新

---

**最終更新日**: 2025-10-26
**バージョン**: 1.0
**実装者**: Claude Code
