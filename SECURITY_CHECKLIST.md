# G-progress セキュリティチェックリスト

本番リリース前およびリリース後の定期的なセキュリティチェック項目です。

## 📋 リリース前チェックリスト

### 🔐 認証・認可

- [ ] **Supabase Auth設定**
  - [ ] メール認証が有効化されている
  - [ ] パスワードポリシーが設定されている（最小8文字以上）
  - [ ] セッションタイムアウトが適切に設定されている
  - [ ] 不要な認証プロバイダーが無効化されている

- [ ] **RLSポリシー**
  - [ ] 全テーブルでRLSが有効化されている
  - [ ] 各テーブルに適切なSELECT/INSERT/UPDATE/DELETEポリシーが設定されている
  - [ ] 管理者・一般ユーザーの権限分離ができている
  - [ ] テストユーザーでポリシーが正しく動作することを確認

- [ ] **権限管理**
  - [ ] RBAC（Role-Based Access Control）が実装されている
  - [ ] 各ページに適切な権限チェックがある
  - [ ] 管理者専用機能が一般ユーザーからアクセスできない

### 🌐 ネットワークセキュリティ

- [ ] **HTTPS/SSL**
  - [ ] 本番環境でHTTPSが有効化されている
  - [ ] HTTP→HTTPSのリダイレクトが設定されている
  - [ ] SSL証明書が有効である
  - [ ] HSTSヘッダーが設定されている

- [ ] **CORS設定**
  - [ ] Supabaseで許可するオリジンが本番ドメインのみに制限されている
  - [ ] 不要なCORSヘッダーが含まれていない

- [ ] **セキュリティヘッダー**
  - [ ] `X-Content-Type-Options: nosniff`
  - [ ] `X-Frame-Options: DENY`
  - [ ] `X-XSS-Protection: 1; mode=block`
  - [ ] `Strict-Transport-Security` (HSTS)
  - [ ] `Content-Security-Policy`
  - [ ] `Referrer-Policy`

### 🗄️ データベースセキュリティ

- [ ] **接続セキュリティ**
  - [ ] データベースへの直接接続が制限されている
  - [ ] 本番DBと開発DBが分離されている
  - [ ] データベース接続文字列が環境変数で管理されている

- [ ] **SQLインジェクション対策**
  - [ ] すべてのクエリでパラメータ化クエリを使用
  - [ ] ユーザー入力を直接SQLに埋め込んでいない
  - [ ] Supabase JavaScriptライブラリを使用している

- [ ] **データ暗号化**
  - [ ] 機密データ（パスワード、個人情報）が暗号化されている
  - [ ] Supabaseの暗号化機能が有効化されている

### 🔑 シークレット管理

- [ ] **環境変数**
  - [ ] `.env`ファイルが`.gitignore`に含まれている
  - [ ] 本番環境の環境変数がVercelに正しく設定されている
  - [ ] APIキーやシークレットがコードにハードコードされていない
  - [ ] `.env.example`に実際の値が含まれていない

- [ ] **APIキー管理**
  - [ ] Supabase Anon Keyのみを使用（Service Keyは使用しない）
  - [ ] Gemini APIキーが適切に保護されている
  - [ ] 不要なAPIキーが削除されている

### 🛡️ XSS/CSRF対策

- [ ] **XSS対策**
  - [ ] ユーザー入力のサニタイゼーション
  - [ ] Content-Security-Policyの設定
  - [ ] `dangerouslySetInnerHTML`の使用箇所を最小化
  - [ ] Reactの自動エスケープ機能を活用

- [ ] **CSRF対策**
  - [ ] Supabaseの認証トークンを使用
  - [ ] 重要な操作に確認ダイアログを表示
  - [ ] SameSite Cookie属性の設定

### 📝 入力バリデーション

- [ ] **フロントエンド**
  - [ ] 全フォームにバリデーションが実装されている
  - [ ] 必須項目チェックがある
  - [ ] 型チェックがある（メール、電話番号など）
  - [ ] 文字数制限がある

- [ ] **バックエンド**
  - [ ] データベース制約が設定されている（NOT NULL、UNIQUE など）
  - [ ] チェック制約が設定されている
  - [ ] トリガーで不正データを防止している

### 📊 ログ・監査

- [ ] **監査ログ**
  - [ ] 重要な操作（作成・更新・削除）がログに記録されている
  - [ ] ログインイベントが記録されている
  - [ ] エクスポート操作が記録されている
  - [ ] ログに個人情報が含まれていない

- [ ] **エラーログ**
  - [ ] 本番環境でエラーログが記録されている
  - [ ] エラーログにスタックトレースが含まれている（本番環境では非表示）
  - [ ] エラーログに機密情報が含まれていない

## 📋 リリース後チェックリスト（週次）

### 🔍 脆弱性スキャン

- [ ] **依存パッケージチェック**
  ```bash
  npm audit
  npm audit fix
  ```

- [ ] **セキュリティアップデート**
  - [ ] Node.jsのセキュリティパッチを確認
  - [ ] 依存パッケージの脆弱性を確認
  - [ ] Supabaseのセキュリティ通知を確認

### 📈 アクセスログ分析

- [ ] **不審なアクセス検知**
  - [ ] 短時間に大量のリクエスト
  - [ ] 不正なログイン試行の増加
  - [ ] 存在しないURLへのアクセス
  - [ ] SQLインジェクション試行の形跡

```sql
-- 不審なログイン試行の確認
SELECT
  user_id,
  COUNT(*) as failure_count,
  MAX(created_at) as last_attempt
FROM audit_logs
WHERE action = 'login_failed'
  AND created_at >= NOW() - INTERVAL '7 days'
GROUP BY user_id
HAVING COUNT(*) > 10
ORDER BY failure_count DESC;
```

### 🔐 権限レビュー

- [ ] **ユーザー権限確認**
  - [ ] 不要な管理者権限がないか確認
  - [ ] 退職者のアカウントが無効化されているか確認
  - [ ] 長期間ログインがないアカウントを確認

```sql
-- 長期間ログインがないアカウント
SELECT
  email,
  first_name,
  last_name,
  role,
  last_login_at
FROM employees
WHERE is_active = true
  AND (last_login_at IS NULL OR last_login_at < NOW() - INTERVAL '30 days')
ORDER BY last_login_at ASC;
```

## 📋 月次チェックリスト

### 🔄 セキュリティパッチ適用

- [ ] **システム更新**
  - [ ] Node.jsの最新LTSバージョンに更新
  - [ ] npm依存パッケージの更新
  - [ ] Supabaseのバージョン確認

- [ ] **バックアップ確認**
  - [ ] バックアップが正常に作成されているか確認
  - [ ] リストアテストを実施
  - [ ] バックアップの保存期間を確認

### 📝 セキュリティポリシーレビュー

- [ ] **RLSポリシーレビュー**
  - [ ] 新しいテーブルにRLSが設定されているか
  - [ ] ポリシーが適切に動作しているか
  - [ ] 過剰な権限付与がないか

- [ ] **APIレート制限**
  - [ ] Supabaseのレート制限設定を確認
  - [ ] 異常なアクセスパターンがないか確認

## 🚨 インシデント対応

### セキュリティインシデント発生時の手順

1. **初動対応**
   - [ ] 影響範囲の特定
   - [ ] 緊急連絡先への通知
   - [ ] 被害拡大の防止

2. **調査**
   - [ ] ログの保全
   - [ ] 攻撃手法の特定
   - [ ] 影響を受けたデータの特定

3. **対策実施**
   - [ ] 脆弱性の修正
   - [ ] パスワードリセット
   - [ ] アクセス制限の強化

4. **事後対応**
   - [ ] インシデントレポート作成
   - [ ] 再発防止策の策定
   - [ ] ユーザーへの通知（必要に応じて）

## 🔬 セキュリティテスト

### 実施すべきテスト

- [ ] **認証テスト**
  - [ ] ログイン機能のテスト
  - [ ] 不正ログイン試行の検知テスト
  - [ ] セッションタイムアウトのテスト

- [ ] **認可テスト**
  - [ ] 権限による画面制御のテスト
  - [ ] APIエンドポイントの権限チェックテスト
  - [ ] 他ユーザーのデータにアクセスできないことの確認

- [ ] **入力バリデーションテスト**
  - [ ] SQLインジェクション試行
  - [ ] XSSペイロード試行
  - [ ] 不正な値の投入テスト

## 📚 参考資料

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [Supabase Security Best Practices](https://supabase.com/docs/guides/auth/row-level-security)
- [Vercel Security](https://vercel.com/docs/security/security)

---

## ✅ 最終確認

リリース前に以下を確認してください：

- [ ] すべてのチェック項目が完了している
- [ ] セキュリティテストが実施されている
- [ ] バックアップ体制が整っている
- [ ] インシデント対応手順が文書化されている
- [ ] 関係者に緊急連絡先が共有されている

---

**最終更新**: 2025-10-22
**バージョン**: 1.0.0
**次回レビュー日**: リリース後1週間以内
