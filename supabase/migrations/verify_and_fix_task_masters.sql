-- ==========================================
-- タスクマスタの確認と修正
-- ==========================================

-- 1. タスクマスタの件数を確認
SELECT COUNT(*) as task_master_count FROM task_masters;

-- 2. RLSポリシーを確認（無効化して確認）
ALTER TABLE task_masters DISABLE ROW LEVEL SECURITY;

-- 3. 再度件数確認
SELECT COUNT(*) as task_master_count_no_rls FROM task_masters;

-- 4. descriptionカラムの存在確認
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'task_masters';

-- 5. descriptionカラムを追加（存在しない場合のみ）
ALTER TABLE task_masters ADD COLUMN IF NOT EXISTS description TEXT;

-- 6. 既存データを削除
TRUNCATE TABLE task_masters CASCADE;

-- 7. タスクマスタを再投入
INSERT INTO task_masters (business_no, task_order, title, phase, responsible_department, days_from_contract, description) VALUES
  -- 営業・契約フェーズ
  (1, 1, '請負契約', '契約', '営業', 0, '請負契約を締結する'),
  (1, 2, '契約金額確認', '契約', '営業事務', 0, '契約金額を確認・記録する'),
  -- 設計フェーズ
  (2, 11, '設計ヒアリング', '設計', '意匠設計', 7, 'お客様の要望をヒアリングする'),
  (2, 12, 'プラン確定', '設計', '意匠設計', 14, 'プランを確定する'),
  (2, 13, 'プラン確定時資金計画書お客様送付', '設計', '営業事務', 15, '資金計画書をお客様に送付する'),
  (2, 14, '構造GO', '設計', '構造設計', 21, '構造設計の承認を得る'),
  (2, 15, '申請GO', '設計', '申請設計', 28, '建築申請の承認を得る'),
  (2, 16, '構造1回目CB', '設計', '構造設計', 30, '構造設計の1回目チェックバック'),
  (2, 17, '構造2回目CB', '設計', '構造設計', 35, '構造設計の2回目チェックバック'),
  (2, 18, '打合せ可能日設定', '設計', 'IC', 40, 'お客様との打合せ可能日を設定する'),
  (2, 19, '平日・WEB打合せキャンペーン確認', '設計', 'IC', 40, 'キャンペーン適用可否を確認する'),
  (2, 20, '特典内容決定', '設計', 'IC', 45, 'お客様への特典内容を決定する'),
  (2, 21, 'オリジナルキッチン選定', '設計', 'IC', 50, 'オリジナルキッチンの有無・仕様を決定する'),
  (2, 22, 'オリジナルアイアン階段選定', '設計', 'IC', 50, 'オリジナルアイアン階段の有無・仕様を決定する'),
  (2, 23, 'IC特典内容（回数）設定', '設計', 'IC', 55, 'IC特典の回数を設定する'),
  (2, 24, '打合回数記録', '設計', 'IC', 60, 'お客様との打合せ回数を記録する'),
  (2, 25, 'YouTubeおすすめ', '設計', 'IC', 60, 'YouTube参考動画をおすすめする'),
  (2, 26, '最終打合', '設計', 'IC', 70, '最終打合せを実施する'),
  (2, 27, '会議図面渡し日設定', '設計', '実施設計', 75, '会議図面の渡し日を設定する'),
  (2, 28, '変更契約前会議', '設計', '営業', 80, '変更契約前の会議を実施する'),
  (2, 29, '図面UP', '設計', '実施設計', 85, '図面をアップロードする'),
  (2, 30, '構造図Up', '設計', '構造設計', 85, '構造図をアップロードする'),
  -- 融資・申請フェーズ
  (3, 31, '着工許可', '申請', '申請設計', 90, '着工許可を取得する'),
  (3, 32, '長期融資申込', '融資', 'ローン事務', 60, '長期融資の申込を行う'),
  (3, 33, 'フラット融資申込', '融資', 'ローン事務', 60, 'フラット融資の申込を行う'),
  (3, 34, 'フラット設計に関する通知書提出', '融資', 'ローン事務', 65, 'フラット設計通知書を提出する'),
  (3, 35, '建築確認済証取得', '申請', '申請設計', 90, '建築確認済証を取得する'),
  (3, 36, '中間検査合格証取得準備', '申請', '申請設計', 120, '中間検査合格証取得の準備をする'),
  (3, 37, '検査済証取得準備', '申請', '申請設計', 150, '検査済証取得の準備をする'),
  (3, 38, '銀行名記録', '融資', 'ローン事務', 60, '融資銀行名を記録する'),
  (3, 39, '事前申込許可取得', '融資', 'ローン事務', 65, '事前申込の許可を取得する'),
  (3, 40, '本申込許可取得', '融資', 'ローン事務', 75, '本申込の許可を取得する'),
  -- 解体・土地関連フェーズ
  (4, 41, '解体工事確認', '工事準備', '工事', 30, '解体工事の有無を確認する'),
  (4, 42, '解体業者選定', '工事準備', '工事', 32, '解体業者を選定する'),
  (4, 43, '解体補助金申請', '工事準備', '工事事務', 35, '解体補助金の申請を行う'),
  (4, 44, '鎮め物棟札準備', '工事準備', '工事', 40, '鎮め物・棟札を準備する'),
  (4, 45, '埋蔵文化財確認', '工事準備', '工事', 25, '埋蔵文化財区域の確認を行う'),
  (4, 46, '解体工事実施', '工事準備', '工事', 45, '解体工事を実施する（開始日・完了日記録）'),
  (4, 47, '変更契約締結', '契約', '営業', 85, '変更契約を締結する'),
  (4, 48, '土地決済', '契約', '営業', 30, '土地の決済を行う'),
  (4, 49, '分筆手続き', '契約', '営業', 35, '分筆手続きを行う（有無・完了日記録）'),
  (4, 50, '新規水道引き込み工事', '工事準備', '工事', 50, '新規水道引き込み工事を実施する'),
  -- 工事フェーズ
  (5, 51, '請負契約着工日設定', '工事', '工事', 90, '請負契約時の着工日を設定する'),
  (5, 52, '変更契約着工日設定', '工事', '工事', 95, '変更契約時の着工日を設定する'),
  (5, 53, '着工前先行工事', '工事', '工事', 88, '着工前の先行工事を実施する'),
  (5, 54, '地盤補強工事', '工事', '工事', 92, '地盤補強工事を実施する（有無・工事日記録）'),
  (5, 55, '基礎着工', '工事', '工事', 95, '基礎工事を着工する'),
  (5, 56, '実行予算完成', '工事', '積算・発注', 100, '実行予算を完成させる'),
  (5, 57, '上棟', '工事', '工事', 110, '上棟を実施する'),
  (5, 58, '中間検査', '工事', '工事', 120, '中間検査を実施する'),
  (5, 59, '完了検査前先行工事', '工事', '工事', 145, '完了検査前の先行工事を実施する'),
  (5, 60, '完了検査', '工事', '工事', 150, '完了検査を実施する'),
  (5, 61, '引渡日設定', '工事', '工事', 155, '引渡日を設定する'),
  (5, 62, '施主希望カギ渡し日設定', '工事', '工事', 155, '施主希望のカギ渡し日を設定する'),
  -- 外構フェーズ
  (6, 71, '外構工事開始', '外構', '外構工事', 120, '外構工事を開始する'),
  (6, 72, '外構工事完了', '外構', '外構工事', 150, '外構工事を完了する'),
  -- 管理・事務フェーズ
  (7, 76, '進捗状況記録', '管理', '工事', 0, '進捗状況・問題点・アクションプランを記録する'),
  (7, 77, '備考記録', '管理', '営業', 0, 'お客様個別情報・注意点を記録する'),
  (7, 78, '補助金申請', '事務', '工事事務', 30, '補助金の申請を行う'),
  (7, 79, '長期要件確認', '事務', 'ローン事務', 60, '長期融資の要件を確認する'),
  (7, 80, 'GX要件確認', '事務', 'ローン事務', 60, 'GX要件を確認する'),
  -- 入金管理フェーズ
  (8, 91, '申込金入金確認', '入金管理', '営業事務', 5, '申込金の日付・金額を記録する'),
  (8, 92, '契約金入金確認', '入金管理', '営業事務', 10, '契約金の日付・金額を記録する'),
  (8, 93, '着工金入金確認', '入金管理', '営業事務', 95, '着工金の日付・金額を記録する'),
  (8, 94, '上棟金入金確認', '入金管理', '営業事務', 115, '上棟金の日付・金額を記録する'),
  (8, 95, '最終金入金確認', '入金管理', '営業事務', 160, '最終金の日付・金額を記録する');

-- 8. RLSを再度有効化
ALTER TABLE task_masters ENABLE ROW LEVEL SECURITY;

-- 9. RLSポリシーを設定
DROP POLICY IF EXISTS "全従業員がタスクマスタを閲覧可能" ON task_masters;
CREATE POLICY "全従業員がタスクマスタを閲覧可能" ON task_masters
  FOR SELECT USING (true);

DROP POLICY IF EXISTS "管理者のみがタスクマスタを編集可能" ON task_masters;
CREATE POLICY "管理者のみがタスクマスタを編集可能" ON task_masters
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM employees
      WHERE employees.id = auth.uid()
      AND employees.role IN ('president', 'executive', 'department_head')
    )
  );

-- 10. 最終確認
SELECT COUNT(*) as final_count FROM task_masters;
SELECT * FROM task_masters ORDER BY task_order LIMIT 10;
